version: 1
backend:
  phases:
    build:
      commands:
        - echo "Building backend..."
        - pip install --upgrade pip
        - pip install -r requirements.txt
  functions:
    api:
      handler: lambda_handler.handler
      runtime: python3.10
      environment:
        SECRET_KEY: ${env.SECRET_KEY}
        ENCRYPTION_KEY: ${env.ENCRYPTION_KEY}
        OPENAI_API_KEY: ${env.OPENAI_API_KEY}
        DATABASE_URL: ${env.DATABASE_URL}
        DEBUG: ${env.DEBUG}
frontend:
  phases:
    preBuild:
      commands:
        - echo "Installing dependencies..."
        - pip install --upgrade pip
        - pip install -r requirements.txt
    build:
      commands:
        - echo "Build complete - using backend function"
  artifacts:
    baseDirectory: .
    files:
      - '**/*'
    test:
      phases:
        preTest:
          commands:
            - echo "Running tests..."
            - pip install pytest pytest-cov
            - mkdir -p coverage/html || true
        test:
          commands:
            - pytest tests/ -v --cov=src --cov-report=term-missing --cov-report=html:coverage/html || true
      artifacts:
        baseDirectory: coverage
        files:
          - '**/*'
    customHeaders:
      - pattern: '**/*'
        headers:
          - key: 'X-Content-Type-Options'
            value: 'nosniff'
          - key: 'X-Frame-Options'
            value: 'DENY'
          - key: 'X-XSS-Protection'
            value: '1; mode=block'
          - key: 'Strict-Transport-Security'
            value: 'max-age=31536000; includeSubDomains'

